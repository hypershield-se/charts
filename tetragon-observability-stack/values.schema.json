{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Tetragon Observability Stack Helm Chart Values",
  "description": "Schema for validating values.yaml configuration for the Tetragon Observability Stack",
  "type": "object",
  "properties": {
    "global": {
      "type": "object",
      "description": "Global settings applied across all subcharts",
      "properties": {
        "clusterName": {
          "type": "string",
          "description": "Cluster identifier for telemetry labeling and routing",
          "minLength": 1,
          "default": "my-cluster"
        },
        "namespace": {
          "type": "string",
          "description": "Default namespace for all components",
          "minLength": 1,
          "default": "tetragon"
        },
        "otelGatewayEndpoint": {
          "type": "string",
          "description": "OpenTelemetry Collector Gateway endpoint (REQUIRED when otelAgent is enabled). Example: otel-collector-gateway.monitoring.svc.cluster.local:4317",
          "pattern": "^[a-zA-Z0-9.-]+:[0-9]+$|^$"
        },
        "otelGatewayTLS": {
          "type": "object",
          "description": "TLS configuration for OTel Gateway connection",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false
            },
            "insecure": {
              "type": "boolean",
              "default": true
            },
            "ca_file": {
              "type": "string"
            },
            "cert_file": {
              "type": "string"
            },
            "key_file": {
              "type": "string"
            }
          }
        }
      },
      "required": ["clusterName", "namespace"]
    },
    "policies": {
      "type": "object",
      "description": "Policy management configuration",
      "properties": {
        "mandateSource": {
          "type": "string",
          "description": "How to provide mandate file: 'configmap' (embedded) or 'url' (external HTTPS)",
          "enum": ["configmap", "url"],
          "default": "configmap"
        },
        "mandateUrl": {
          "type": "string",
          "description": "External mandate URL (REQUIRED when mandateSource is 'url')"
        },
        "mandateRefreshPeriod": {
          "type": "string",
          "description": "How often to check for mandate updates (URL-based mandates only). Supports Go duration format (e.g., 1m0s, 5m, 1h30m)",
          "pattern": "^([0-9]+(ns|us|ms|s|m|h))+$",
          "default": "1m0s"
        },
        "mandate": {
          "type": "object",
          "description": "Mandate configuration for ConfigMap source",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true
            },
            "info": {
              "type": "object",
              "properties": {
                "version": {
                  "type": "string"
                },
                "description": {
                  "type": "string"
                },
                "owner": {
                  "type": "string"
                }
              }
            },
            "mode": {
              "type": "string",
              "description": "Policy enforcement mode",
              "enum": ["monitor", "enforce"],
              "default": "monitor"
            },
            "policies": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "enabled": {
                    "type": "boolean"
                  },
                  "mode": {
                    "type": "string",
                    "enum": ["monitor", "enforce"]
                  }
                },
                "required": ["name", "enabled"]
              }
            }
          }
        },
        "tracingPolicies": {
          "type": "object",
          "description": "TracingPolicy definitions embedded in ConfigMaps",
          "properties": {
            "networkConnections": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": true
                }
              }
            },
            "dnsMonitoring": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                }
              }
            },
            "httpMonitoring": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                }
              }
            },
            "tlsMonitoring": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "default": false
                }
              }
            }
          }
        }
      },
      "required": ["mandateSource"]
    },
    "tetragon": {
      "type": "object",
      "description": "Tetragon DaemonSet configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable Tetragon deployment",
          "default": true
        },
        "export": {
          "type": "object",
          "properties": {
            "mode": {
              "type": "string",
              "enum": ["stdout", "file"],
              "default": "file"
            },
            "filenames": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "directory": {
              "type": "string"
            }
          }
        },
        "exportAllowList": {
          "type": "string",
          "description": "JSON string defining allowed event types"
        },
        "exportDenyList": {
          "type": "string",
          "description": "JSON string defining events to filter out"
        },
        "exportRateLimit": {
          "type": "integer",
          "description": "Maximum events per minute (-1 for unlimited)",
          "minimum": -1,
          "default": 10000
        },
        "eventQueueSize": {
          "type": "integer",
          "description": "Event queue buffer size",
          "minimum": 100,
          "default": 10000
        },
        "enableProcessCred": {
          "type": "boolean",
          "default": true
        },
        "enableProcessNs": {
          "type": "boolean",
          "default": true
        },
        "enableProcessAncestors": {
          "type": "boolean",
          "default": true
        },
        "enableK8sAPI": {
          "type": "boolean",
          "default": true
        },
        "resources": {
          "type": "object",
          "properties": {
            "limits": {
              "type": "object",
              "properties": {
                "cpu": {
                  "type": "string"
                },
                "memory": {
                  "type": "string"
                }
              }
            },
            "requests": {
              "type": "object",
              "properties": {
                "cpu": {
                  "type": "string"
                },
                "memory": {
                  "type": "string"
                }
              }
            }
          }
        },
        "priorityClassName": {
          "type": "string"
        },
        "policyServer": {
          "type": "string"
        }
      }
    },
    "fluentbit": {
      "type": "object",
      "description": "Fluent Bit DaemonSet configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable Fluent Bit deployment",
          "default": true
        },
        "image": {
          "type": "object",
          "properties": {
            "repository": {
              "type": "string"
            },
            "tag": {
              "type": "string"
            },
            "pullPolicy": {
              "type": "string",
              "enum": ["Always", "IfNotPresent", "Never"]
            }
          }
        },
        "resources": {
          "type": "object"
        },
        "tolerations": {
          "type": "array"
        },
        "service": {
          "type": "object"
        },
        "config": {
          "type": "object"
        },
        "volumeMounts": {
          "type": "array"
        },
        "daemonSetVolumes": {
          "type": "array"
        },
        "env": {
          "type": "array"
        }
      }
    },
    "otelAgent": {
      "type": "object",
      "description": "OpenTelemetry Collector Agent DaemonSet configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable OTel Collector Agent deployment",
          "default": true
        },
        "mode": {
          "type": "string",
          "description": "Deployment mode (must be daemonset for node-level collection)",
          "enum": ["daemonset", "deployment", "statefulset"],
          "default": "daemonset"
        },
        "image": {
          "type": "object",
          "properties": {
            "repository": {
              "type": "string"
            },
            "tag": {
              "type": "string"
            }
          }
        },
        "service": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "type": {
              "type": "string",
              "enum": ["ClusterIP", "NodePort", "LoadBalancer"]
            }
          }
        },
        "ports": {
          "type": "object"
        },
        "resources": {
          "type": "object"
        },
        "extraEnvs": {
          "type": "array"
        },
        "extraVolumes": {
          "type": "array"
        },
        "extraVolumeMounts": {
          "type": "array"
        },
        "config": {
          "type": "object",
          "description": "OpenTelemetry Collector configuration"
        }
      }
    },
    "monitoring": {
      "type": "object",
      "description": "Prometheus Operator monitoring configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable ServiceMonitor creation",
          "default": false
        },
        "serviceMonitors": {
          "type": "object",
          "properties": {
            "tetragon": {
              "type": "object",
              "properties": {
                "enabled": {
                  "type": "boolean"
                },
                "interval": {
                  "type": "string"
                },
                "scrapeTimeout": {
                  "type": "string"
                },
                "labels": {
                  "type": "object"
                }
              }
            },
            "fluentbit": {
              "type": "object"
            },
            "otelAgent": {
              "type": "object"
            }
          }
        }
      }
    },
    "networkPolicies": {
      "type": "object",
      "description": "NetworkPolicy configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable NetworkPolicy creation",
          "default": false
        },
        "tetragon": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "allowKubeAPIAccess": {
              "type": "boolean"
            }
          }
        },
        "fluentbit": {
          "type": "object"
        },
        "otelAgent": {
          "type": "object"
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "policies": {
            "properties": {
              "mandateSource": {
                "const": "url"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "policies": {
            "required": ["mandateUrl"],
            "properties": {
              "mandateUrl": {
                "minLength": 1
              }
            }
          }
        }
      }
    }
  ],
  "required": ["global", "policies"]
}
