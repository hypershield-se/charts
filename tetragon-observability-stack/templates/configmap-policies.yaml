{{- if and (eq .Values.policies.mandateSource "configmap") .Values.policies.mandate.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "tetragon-observability-stack.fullname" . }}-policies
  namespace: {{ include "tetragon-observability-stack.namespace" . }}
  labels:
    {{- include "tetragon-observability-stack.labels" . | nindent 4 }}
    app.kubernetes.io/component: tetragon-policy
data:
  {{- if (index .Values.policies.tracingPolicies "networkConnections").enabled }}
  network-connections.yaml: |
    apiVersion: cilium.io/v1alpha1
    kind: TracingPolicy
    metadata:
      name: network-connections
      labels:
        category: network
        protocol: tcp
    spec:
      kprobes:
      # TCP connect - outbound connections
      - call: "tcp_connect"
        syscall: false
        args:
        - index: 0
          type: "sock"
        selectors:
        - matchArgs:
          - index: 0
            operator: "NotDAddr"
            values:
            - "127.0.0.1"
      # TCP accept - inbound connections
      - call: "tcp_accept"
        syscall: false
        return: true
        args:
        - index: 0
          type: "sock"
        returnArg:
          index: 0
          type: "sock"
      # TCP close - connection closure with stats
      - call: "tcp_close"
        syscall: false
        args:
        - index: 0
          type: "sock"
  {{- end }}

  {{- if (index .Values.policies.tracingPolicies "dnsMonitoring").enabled }}
  dns-monitoring.yaml: |
    apiVersion: cilium.io/v1alpha1
    kind: TracingPolicy
    metadata:
      name: dns-monitoring
      labels:
        category: network
        protocol: dns
    spec:
      kprobes:
      - call: "udp_sendmsg"
        syscall: false
        args:
        - index: 0
          type: "sock"
        - index: 1
          type: "msg_hdr"
        selectors:
        - matchArgs:
          - index: 0
            operator: "DPort"
            values:
            - "53"
  {{- end }}

  {{- if (index .Values.policies.tracingPolicies "httpMonitoring").enabled }}
  http-monitoring.yaml: |
    apiVersion: cilium.io/v1alpha1
    kind: TracingPolicy
    metadata:
      name: http-monitoring
      labels:
        category: network
        protocol: http
    spec:
      kprobes:
      - call: "tcp_sendmsg"
        syscall: false
        args:
        - index: 0
          type: "sock"
        - index: 1
          type: "msg_hdr"
        - index: 2
          type: "size_t"
        selectors:
        - matchArgs:
          - index: 0
            operator: "DPort"
            values:
            - "80"
            - "8080"
            - "443"
            - "8443"
  {{- end }}

  {{- if (index .Values.policies.tracingPolicies "tlsMonitoring").enabled }}
  tls-monitoring.yaml: |
    apiVersion: cilium.io/v1alpha1
    kind: TracingPolicy
    metadata:
      name: tls-monitoring
      labels:
        category: network
        protocol: tls
    spec:
      kprobes:
      - call: "tcp_sendmsg"
        syscall: false
        args:
        - index: 0
          type: "sock"
        - index: 1
          type: "msg_hdr"
        selectors:
        - matchArgs:
          - index: 0
            operator: "DPort"
            values:
            - "443"
            - "8443"
  {{- end }}
{{- end }}
